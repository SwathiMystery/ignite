//-
    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at
         http://www.apache.org/licenses/LICENSE-2.0
    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

extends ../templates/layout

append scripts
    script(src='/sql-controller.js')

    script(src='//cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/theme-chrome.js')
    script(src='//cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/mode-sql.js')
    script(src='//cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/ext-language_tools.js')
    script(src='//cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js')
    script(src='//cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.1/nv.d3.js')
    link(rel='stylesheet', href='//cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.1/nv.d3.css')

mixin btn-toolbar(btn, click, tip)
    i.btn.btn-default.fa(class=btn ng-click=click bs-tooltip='' data-title=tip data-trigger='hover' data-placement='bottom')

mixin btn-toolbar-data(btn, kind, tip)
    i.btn.btn-default.fa(class=btn ng-click='setResult(paragraph, "#{kind}")' ng-class='{active: resultEq(paragraph, "#{kind}")}' bs-tooltip='' data-title=tip data-trigger='hover' data-placement='bottom')

block container
    .row
        .col-sm-12(ng-init='noteId = "#{noteId}"')
            .docs-content(ng-controller='sqlController' )
                .docs-header.notebook-header
                    h1.col-sm-6(ng-hide='notebook.edit')
                        label {{notebook.name}}
                        .btn-group
                            +btn-toolbar('fa-pencil', 'notebook.edit = true;notebook.edit_name = notebook.name', 'Rename notebook')
                            +btn-toolbar('fa-trash', 'removeNotebook()', 'Remove notebook')
                    h1.col-sm-6(ng-show='notebook.edit')
                        input.sql-name-input(ng-model='notebook.edit_name' required on-enter='renameNotebook(notebook.edit_name)' on-escape='notebook.edit = false;')
                        i.tipLabel.fa.fa-floppy-o(ng-show='notebook.edit_name' ng-click='renameNotebook(notebook.edit_name)' bs-tooltip data-title='Save notebook name' data-trigger='hover')
                    .pull-right
                        +btn-toolbar('fa-plus', 'addParagraph()', 'Add new query')
                hr
                .docs-body.paragraphs
                    .panel-group(bs-collapse ng-model='notebook.expandedParagraphs' data-allow-multiple='true' data-start-collapsed='false')
                        .panel.panel-default(ng-repeat='paragraph in notebook.paragraphs')
                            .panel-heading(bs-collapse-toggle)
                                div(ng-hide='paragraph.edit')
                                    a {{paragraph.name}}

                                    .btn-group(ng-hide='notebook.paragraphs.length > 1')
                                        +btn-toolbar('fa-pencil', 'paragraph.edit = true; paragraph.edit_name = paragraph.name; $event.stopPropagation();', 'Rename paragraph')

                                    .btn-group(ng-show='notebook.paragraphs.length > 1' ng-click='$event.stopPropagation();')
                                        +btn-toolbar('fa-pencil', 'paragraph.edit = true; paragraph.edit_name = paragraph.name;', 'Rename paragraph')
                                        +btn-toolbar('fa-remove', 'removeParagraph(paragraph)', 'Remove paragraph')

                                    .btn-group(ng-model='paragraph.result' ng-click='$event.stopPropagation()' style='float: right')
                                        +btn-toolbar-data('fa-table', 'table', 'Show data in tabular form.')
                                        +btn-toolbar-data('fa-bar-chart', 'bar', 'Show bar chart.<br/>By default first column - X values, second column - Y values.<br/>In case of one column it will be treated as Y values.')
                                        +btn-toolbar-data('fa-pie-chart', 'pie', 'Show pie chart.<br/>By default first column - pie values, second column - pie labels.<br/>In case of one column it will be treated as pie values.')
                                        +btn-toolbar-data('fa-line-chart', 'line', 'Show line chart.<br/>By default first column - X values, second column - Y values.<br/>In case of one column it will be treated as Y values.')
                                        +btn-toolbar-data('fa-area-chart', 'area', 'Show area chart.<br/>By default first column - X values, second column - Y values.<br/>In case of one column it will be treated as Y values.')
                                div(ng-show='paragraph.edit')
                                    input.sql-name-input(ng-model='paragraph.edit_name' required ng-click='$event.stopPropagation();' on-enter='renameParagraph(paragraph, paragraph.edit_name)' on-escape='paragraph.edit = false')
                                    i.tipLabel.fa.fa-floppy-o(ng-show='paragraph.edit_name' ng-click='renameParagraph(paragraph, paragraph.edit_name); $event.stopPropagation();' bs-tooltip data-title='Save paragraph name' data-trigger='hover')
                            .panel-collapse(role='tabpanel' bs-collapse-target)
                                .col-sm-12(ng-show='paragraph.editor')
                                    .col-xs-8.col-sm-9(style='border-right: 1px solid #eee')
                                        .sql-editor(ui-ace='{onLoad: aceInit, theme: "chrome", mode: "sql", require: ["ace/ext/language_tools"],' +
                                            'advanced: {enableSnippets: false, enableBasicAutocompletion: true, enableLiveAutocompletion: true}}'
                                        ng-model='paragraph.query'
                                        ng-class='{"disable": paragraph.status == "RUNNING" || paragraph.status == "PENDING" }')
                                    .col-xs-4.col-sm-3
                                        div(ng-show='caches.length > 0' style='padding: 5px 10px' st-table='displayedCaches' st-safe-src='caches')
                                            lable.labelField.labelFormField Caches:
                                            .input-tip
                                                input.form-control(type='text' st-search placeholder='Filter caches...')
                                            table.links
                                                tbody
                                                    tr(ng-repeat='cache in displayedCaches track by cache.name')
                                                        td(style='width: 100%')
                                                            a(ng-class='{active: cache.name == paragraph.cache.name}' ng-click='paragraph.cache = cache') {{$index + 1}}) {{::cache.name}}
                                                        //td(style='width: 15px')
                                                        //    i.fa.fa-info-circle(bs-popover data-template-url='cache-metadata' data-placement='left' data-auto-close='1' data-trigger='click')
                                        .empty-caches(ng-show='displayedCaches.length == 0 && caches.length != 0')
                                            label Wrong caches filter
                                        .empty-caches(ng-show='caches.length == 0')
                                            label No caches
                                .col-sm-12
                                    hr(style='margin: 0')
                                .col-sm-12
                                    .details-row
                                        a.btn.btn-primary(ng-disabled='!actionAvailable(paragraph, true)' ng-click='actionAvailable(paragraph, true) ? explain(paragraph) : ""' data-placement='bottom' bs-tooltip data-title='{{actionTooltip(paragraph, "explain", true)}}') Explain
                                        a.btn.btn-primary(ng-disabled='!actionAvailable(paragraph, true)' ng-click='actionAvailable(paragraph, true) ? execute(paragraph) : ""' data-placement='bottom' bs-tooltip data-title='{{actionTooltip(paragraph, "execute", true)}}') Execute
                                        a.btn.btn-primary(ng-disabled='!actionAvailable(paragraph, false)' ng-click='actionAvailable(paragraph, false) ? scan(paragraph): ""' data-placement='bottom' bs-tooltip data-title='{{actionTooltip(paragraph, "execute scan", false)}}') Scan
                                        .pull-right
                                            label Refresh rate:
                                            button.btn.btn-default.fa.fa-clock-o.tipLabel(ng-class='{"btn-info": paragraph.rate && paragraph.rate.installed}' bs-popover data-template-url='rate' data-placement='left' data-auto-close='1' data-trigger='click') {{rateAsString(paragraph)}}
                                            label.tipLabel Page size:
                                            button.btn.btn-default.base-control.tipLabel(ng-model='paragraph.pageSize' bs-options='item for item in pageSizes' bs-select style='margin-right: 0')
                                            label(style='margin-left: 10px')
                                                input(type='checkbox' ng-model='paragraph.hideSystemColumns' ng-click='applySystemColumns(paragraph)' ng-disabled='paragraph.disabledSystemColumns')
                                                | Hide system columns
                                .col-sm-12(ng-show='paragraph.errMsg')
                                    hr(style='margin-top: 0; margin-bottom: 10px')
                                    .sql-error-result(ng-show='paragraph.errMsg') Error: {{paragraph.errMsg}}
                                .col-sm-12(ng-show='!paragraph.errMsg')
                                    hr(ng-show='paragraph.result != "none"' style='margin-top: 0; margin-bottom: 10px')
                                    div(ng-show='paragraph.rows && paragraph.result === "table"')
                                        .sql-table-total(ng-show='paragraph.rows && paragraph.result === "table"')
                                            label Page #:&nbsp;
                                            b {{paragraph.page}}&nbsp;&nbsp;&nbsp;
                                            label Results:&nbsp;
                                            b {{paragraph.rows.length + paragraph.total}}
                                            .pull-right
                                                button.btn.btn-primary(ng-click='nextPage(paragraph)' ng-disabled='!paragraph.queryId') Next page
                                                .btn-group
                                                    button.btn.btn-primary.fieldButton(ng-click='exportPage(paragraph)' ) Export
                                                    button.btn.btn-primary(id='export-item-dropdown' data-toggle='dropdown' data-container='body' bs-dropdown='exportDropdown' data-placement='bottom-right')
                                                        span.caret
                                        .sql-table-wrapper
                                            table.table.table-condensed(st-table='displayedResult' st-safe-src='paragraph.rows' float-thead='floatTheadOptions')
                                                thead
                                                    tr
                                                        th(ng-repeat='col in paragraph.meta track by $index' ng-if='paragraph.columnFilter(col)' bs-tooltip='columnToolTip(col)' data-placement='bottom') {{col.fieldName}}
                                                tbody
                                                    tr(ng-repeat='row in displayedResult track by $index')
                                                        td(ng-repeat='val in row track by $index' ng-if='paragraph.columnFilter(paragraph.meta[$index])') {{ val }}
                                    div(ng-show='paragraph.rows && paragraph.result != "table" && paragraph.result != "none"')
                                        button.btn.btn-default.chart-btn.fa.fa-cog(bs-popover data-template-url='chart-settings' data-placement='left' data-auto-close='1' data-trigger='click')
                                        div(id='chart-{{paragraph.id}}')
                                            svg
                                    .sql-empty-result(ng-show='!paragraph.rows && paragraph.result != "none"') Result set is empty.
